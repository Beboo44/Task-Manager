// Placeholder for DashboardController
// This will contain controller actions for Dashboard display
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;
using TaskManager.Business.Services;
using TaskManager.ViewModels;

namespace TaskManager.Controllers
{
    [Authorize]
    public class DashboardController : Controller
    {
        private readonly IDashboardService _dashboardService;
        private readonly IRecommendationService _recommendationService;
        private readonly ILogger<DashboardController> _logger;

        public DashboardController(
            IDashboardService dashboardService,
            IRecommendationService recommendationService,
            ILogger<DashboardController> logger)
        {
            _dashboardService = dashboardService;
            _recommendationService = recommendationService;
            _logger = logger;
        }

        private string GetUserId() => User.FindFirstValue(ClaimTypes.NameIdentifier) ?? string.Empty;

        // GET: /Dashboard
        public async Task<IActionResult> Index()
        {
            var userId = GetUserId();
            
            // Get dashboard data
            var dashboardDto = await _dashboardService.GetDashboardDataAsync(userId);

            // Get recommendation
            var recommendation = await _recommendationService.GetRecommendedTaskAsync(userId);

            // Map to ViewModel
            var viewModel = new DashboardViewModel
            {
                // Statistics
                TotalTasks = dashboardDto.TotalTasks,
                CompletedTasks = dashboardDto.CompletedTasks,
                PendingTasks = dashboardDto.PendingTasks,
                ToDoTasks = dashboardDto.ToDoTasks,
                OverdueTasksCount = dashboardDto.OverdueTasksCount,

                // Percentages
                CompletionPercentage = dashboardDto.CompletionPercentage,
                PendingPercentage = dashboardDto.PendingPercentage,
                OverduePercentage = dashboardDto.OverduePercentage,

                // Priority breakdown
                CriticalPriorityTasks = dashboardDto.CriticalPriorityTasks,
                HighPriorityTasks = dashboardDto.HighPriorityTasks,
                MediumPriorityTasks = dashboardDto.MediumPriorityTasks,
                LowPriorityTasks = dashboardDto.LowPriorityTasks,

                // Task lists
                UpcomingTasks = dashboardDto.UpcomingTasks.Select(t => new TaskViewModel
                {
                    Id = t.Id,
                    Title = t.Title,
                    Description = t.Description,
                    Deadline = t.Deadline,
                    Priority = t.Priority,
                    Status = t.Status,
                    CategoryId = t.CategoryId,
                    CategoryName = t.CategoryName,
                    CreatedAt = t.CreatedAt,
                    UpdatedAt = t.UpdatedAt,
                    CompletedAt = t.CompletedAt
                }).ToList(),

                OverdueTasks = dashboardDto.OverdueTasks.Select(t => new TaskViewModel
                {
                    Id = t.Id,
                    Title = t.Title,
                    Description = t.Description,
                    Deadline = t.Deadline,
                    Priority = t.Priority,
                    Status = t.Status,
                    CategoryId = t.CategoryId,
                    CategoryName = t.CategoryName,
                    CreatedAt = t.CreatedAt,
                    UpdatedAt = t.UpdatedAt,
                    CompletedAt = t.CompletedAt
                }).ToList(),

                // Category stats
                TasksByCategory = dashboardDto.TasksByCategory,

                // Recommendation
                RecommendedTask = recommendation?.Task != null ? new TaskViewModel
                {
                    Id = recommendation.Task.Id,
                    Title = recommendation.Task.Title,
                    Description = recommendation.Task.Description,
                    Deadline = recommendation.Task.Deadline,
                    Priority = recommendation.Task.Priority,
                    Status = recommendation.Task.Status,
                    CategoryId = recommendation.Task.CategoryId,
                    CategoryName = recommendation.Task.CategoryName,
                    CreatedAt = recommendation.Task.CreatedAt,
                    UpdatedAt = recommendation.Task.UpdatedAt,
                    CompletedAt = recommendation.Task.CompletedAt
                } : null,
                RecommendationReason = recommendation?.RecommendationReason,
                RecommendationScore = recommendation?.RecommendationScore
            };

            return View(viewModel);
        }
    }
}
